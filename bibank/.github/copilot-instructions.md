# BiBank - AI Coding Instructions

## Project Vision
BiBank is a **Financial State OS** - NOT a traditional banking app. Core principles:
- **Ledger is the single source of truth** - No DB can "mutate state" directly
- **No reconciliation** - If reconciliation is needed → architecture is wrong
- **Correct-by-construction** - Risk engine blocks invalid state at write-time
- **Event-first** - State is projection, events are truth (JSONL files)

## Architecture (14 Pillars)
```
           ┌────────────┐
           │ Risk Engine│ (Pre-commit Gatekeeper)
           └─────▲──────┘
                 │
Client ──▶ Ledger ──▶ Event Bus ──▶ Projections (SQLite)
                 │
                 ▼
           Audit / Replay
```

## Workspace: 8 Crates
| Crate | Role |
|-------|------|
| `bibank-core` | Domain types (Amount - non-negative Decimal wrapper) |
| `bibank-ledger` | **[HEART]** Double-entry, AccountKey, JournalEntry, Posting |
| `bibank-risk` | **[GATEKEEPER]** Pre-commit checks, in-memory state |
| `bibank-events` | JSONL append/read (Source of Truth) |
| `bibank-bus` | In-process event distribution |
| `bibank-projection` | Event → SQLite views (disposable, rebuildable) |
| `bibank-rpc` | API/CLI orchestrator |
| `bibank-dsl` | DSL macros (future) |

## Critical Patterns

### Double-Entry Accounting
Every `JournalEntry` MUST have **zero-sum per asset**:
```rust
// Deposit 100 USDT to Alice
postings: [
    Posting { account: "ASSET:SYSTEM:VAULT:USDT:MAIN", amount: 100, side: Debit },
    Posting { account: "LIAB:USER:ALICE:USDT:AVAILABLE", amount: 100, side: Credit },
]
// Sum(Debit) - Sum(Credit) = 0 ✅
```

### Ledger Account Key (5-part hierarchical, SCREAMING_SNAKE_CASE)
```
CATEGORY:SEGMENT:ID:ASSET:SUB_ACCOUNT
Example: LIAB:USER:ALICE:USDT:AVAILABLE
```
Categories: `ASSET`, `LIAB`, `EQUITY`, `REV`, `EXP`

### Transaction Intents (Phase 1)
`Genesis`, `Deposit`, `Withdrawal`, `Transfer` (Trade, Fee, Adjustment → Phase 2+)

### Tracing IDs
- `correlation_id`: Request UUID from API/CLI (REQUIRED, never generated by ledger)
- `causality_id`: Optional link to parent entry that caused this

## Invariants - NEVER Violate
1. Ledger is **append-only** - No update/delete
2. Every entry has **strictly increasing sequence** (derived from JSONL line count)
3. Hash chain: `prev_hash` = SHA256 of previous entry
4. Risk Engine checks **BEFORE** ledger commit, not after
5. Risk Engine reads **in-memory state only** (rebuilt from replay), never SQLite
6. `Amount` is always non-negative (type-enforced)

## Data Flow
```
JSONL (data/journal/YYYY-MM-DD.jsonl) → Source of Truth
SQLite (data/projection.db) → Disposable read model (can delete & replay)
```

## Key Files
- [Proposed-BiBank-Phase1.md](docs/proposed/Proposed-BiBank-Phase1.md) - Complete specification
- [IDEA.md](docs/IDEA.md) - Vision & philosophy

## Anti-Patterns to Avoid
- ❌ Mutating balance directly (`balance += amount`)
- ❌ Reading SQLite in Risk Engine
- ❌ Single-entry transactions
- ❌ Generating `correlation_id` inside ledger
- ❌ Skipping sequence numbers
